import{r as u,l as o,aK as re,w as U,bc as oe,aL as ie,cN as ae,m as H,aa as ce,ad as le,aW as ue,n as _,a3 as de,cO as me,ak as pe,cP as fe,cQ as he,cR as ye,a_ as ge,bt as Te,ae as V,o as O,aF as A,q as Le,b_ as Ie,T as C,B as F,aH as Se,F as be,p as Re,cS as Pe,C as k,a4 as _e,t as ve,a8 as Ce,bn as j,cT as Ee,cU as xe,cV as Fe,cW as we,bi as N,Q as De,cX as Oe,cx as je,cy as $e,bl as Ae,cY as ke,cZ as Ne,c2 as W,c4 as We,c_ as Be,bV as Me,bo as qe,bB as Ue,c$ as He,d0 as Ve,d1 as Ye,bW as Ge}from"./desk-0312ba5d-0d65255d.js";import{useDeskTool as Ke,useDeskToolSetting as B,Delay as Xe}from"./index-74d44846-e8a572e4.js";import{P as ze}from"./PaneItem-1352c9b8-47ef14f3.js";import"./index-177a2c5b.js";const M=100,$=2e3,Y={by:[{field:"_updatedAt",direction:"desc"}]},Qe={};function Ze(e,s){return e._id?V(e._id):"item-".concat(s)}function Je(e){return Fe(e).map(s=>({...s.draft||s.published,hasPublished:!!s.published,hasDraft:!!s.draft}))}const et=/\b_type\s*==\s*(['"].*?['"]|\$.*?(?:\s|$))|\B(['"].*?['"]|\$.*?(?:\s|$))\s*==\s*_type\b/;function tt(e){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=e.match(et);if(!n)return null;const t=(n[1]||n[2]).trim().replace(/^["']|["']$/g,"");if(t[0]==="$"){const a=t.slice(1),c=s[a];return typeof c=="string"?c:null}return t}function nt(e){return/^_type\s*==\s*['"$]\w+['"]?\s*$/.test(e.trim())}function st(e){return e.map(s=>[rt(s),(s.direction||"").toLowerCase()].map(n=>n.trim()).filter(Boolean).join(" ")).join(",")}function rt(e){return e.mapWith?"".concat(e.mapWith,"(").concat(e.field,")"):e.field}function ot(e,s){const n=e.by.map(t=>{if(t.mapWith)return t;const a=it(s,t.field);return a?ct(a,"datetime")?{...t,mapWith:"dateTime"}:a.jsonType==="string"?{...t,mapWith:"lower"}:t:t});return n.every((t,a)=>t===e.by[a])?e:{...e,by:n}}function it(e,s){const n=pe(s);let t=e;for(const a of n){if(!t)return;if(typeof a=="string"){t=at(t,a);continue}if(!(fe(a)||he(a))||t.jsonType!=="array")return;const[r,i]=t.of||[];if(i||!r)return;if(!ye(r)){t=r;continue}const[f,h]=r.to||[];if(h||!f)return;t=f}return t}function at(e,s){if(!("fields"in e))return;const n=e.fields.find(t=>t.name===s);return n?n.type:void 0}function ct(e,s){let n=e.type;for(;n;){if(n.name===s||!n.type&&n.jsonType===s)return!0;n=n.type}return!1}function lt(e){const{childItemId:s,error:n,filterIsSimpleTypeContraint:t,fullList:a,isActive:c,isLoading:r,items:i,layout:f,onListChange:h,onRetry:l,showIcons:y}=e,b=H(),{collapsed:S}=ge(),{collapsed:I,index:g}=Te(),[R,P]=u.useState(!1);u.useEffect(()=>{if(I)return;const d=setTimeout(()=>{P(!0)},0);return()=>{clearTimeout(d)}},[I]);const T=u.useCallback(d=>{const L=V(d._id),m=s===L;return o(ze,{icon:y===!1?!1:void 0,id:L,pressed:!c&&m,selected:c&&m,layout:f,schemaType:b.get(d._type),value:d})},[s,c,f,b,y]),p=u.useMemo(()=>{if(!R)return null;if(n)return o(O,{align:"center",direction:"column",height:"fill",justify:"center",children:o(A,{width:1,children:_(Le,{paddingX:4,paddingY:5,space:4,children:[o(Ie,{as:"h3",children:"Could not fetch list items"}),_(C,{as:"p",children:["Error: ",o("code",{children:n.message})]}),l&&o(F,{children:o(U,{icon:Se,onClick:l,text:"Retry",tone:"primary"})})]})})});if(i===null)return o(O,{align:"center",direction:"column",height:"fill",justify:"center",children:o(Xe,{ms:300,children:_(be,{children:[o(Re,{muted:!0}),o(F,{marginTop:3,children:o(C,{align:"center",muted:!0,size:1,children:"Loading documents…"})})]})})});if(!r&&i.length===0)return o(O,{align:"center",direction:"column",height:"fill",justify:"center",children:o(A,{width:1,children:o(F,{paddingX:4,paddingY:5,children:o(C,{align:"center",muted:!0,size:2,children:t?"No documents of this type":"No matching documents"})})})});const d=a&&i.length===$;return _(F,{padding:2,children:[i.length>0&&o(Pe,{gap:1,getItemKey:Ze,items:i,renderItem:T,onChange:h},"".concat(g,"-").concat(I)),r&&o(k,{borderTop:!0,marginTop:1,paddingX:3,paddingY:4,children:o(C,{align:"center",muted:!0,size:1,children:"Loading…"})}),d&&o(k,{marginTop:1,paddingX:3,paddingY:4,radius:2,tone:"transparent",children:_(C,{align:"center",muted:!0,size:1,children:["Displaying a maximum of ",$," documents"]})})]})},[n,t,a,h,r,i,l,T,R,I,g]);return o(_e,{overflow:S?void 0:"auto",children:p})}const G=u.memo(e=>{let{index:s,initialValueTemplates:n=[],menuItems:t=[],menuItemGroups:a=[],setLayout:c,setSortOrder:r,title:i}=e;const{features:f}=Ke(),h=u.useMemo(()=>({setLayout:l=>{let{layout:y}=l;c(y)},setSortOrder:l=>{r(l)}}),[c,r]);return o(re,{backButton:f.backButton&&s>0&&o(U,{as:oe,"data-as":"a",icon:ie,mode:"bleed"}),title:i,actions:o(ae,{initialValueTemplateItems:n,actionHandlers:h,menuItemGroups:a,menuItems:t})})});G.displayName="DocumentListPaneHeader";const ut={result:null,error:!1},dt=e=>({result:{documents:e},loading:!1,error:!1}),mt=e=>({result:null,loading:!1,error:e}),pt=function(e){let s=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new we,t=n.next.bind(n);return e.pipe(N(r=>({client:r.client,query:r.query,params:r.params})),De(Oe),je(1),$e()).pipe(Ae(r=>{const i=ke(r.client,r.query,r.params,s).pipe(N(dt),Ne());return W(j({loading:!0}).pipe(We(400),Be(i)),i)})).pipe(Me(ut),qe((r,i)=>Ue(j(mt(r)),W(He(window,"online"),n).pipe(Ve(1),Ye(i)))),Ge((r,i)=>({...r,...i,onRetry:t})))};function ft(e){var s;const{apiVersion:n,filter:t,params:a,sortOrder:c}=e,r=ve(Ce),[i,f]=u.useState(!1),h=u.useRef(i),[l,y]=u.useState(null),b=(l==null?void 0:l.error)||null,S=(l==null?void 0:l.loading)||l===null,I=l==null?void 0:l.onRetry,g=(s=l==null?void 0:l.result)==null?void 0:s.documents,R=u.useMemo(()=>g?Je(g):null,[g]),P=u.useMemo(()=>{const p=c==null?void 0:c.extendedProjection,d=["_id","_type"],L=d.join(","),m=(c==null?void 0:c.by)||[],v=i?$:M,E=m.length>0?m:Y.by,x=st(E);if(p){const w=d.concat(p).join(",");return["*[".concat(t,"] {").concat(w,"}"),"order(".concat(x,") [0...").concat(v,"]"),"{".concat(L,"}")].join("|")}return"*[".concat(t,"]|order(").concat(x,")[0...").concat(v,"]{").concat(L,"}")},[t,i,c]),T=u.useCallback(p=>{let{toIndex:d}=p;S||h.current||d>=M/2&&(f(!0),h.current=!0)},[S]);return u.useEffect(()=>{const p=i?m=>Boolean(m.result):()=>!0;y(m=>m?{...m,loading:!0}:null);const L=pt(j({client:r,query:P,params:a}),{apiVersion:n,tag:"desk.document-list"}).pipe(Ee(p)).subscribe(y);return()=>L.unsubscribe()},[n,r,i,P,a]),u.useEffect(()=>{y(null),f(!1),h.current=!1},[t,a,c,n]),{error:b,fullList:i,handleListChange:T,isLoading:S,items:R,onRetry:I}}const q=[];function ht(e){const s=u.useRef(e);return xe(s.current,e)||(s.current=e),s.current}const It=u.memo(function(s){const{childItemId:n,index:t,isActive:a,isSelected:c,pane:r,paneKey:i}=s,f=H(),{name:h}=ce(),{defaultLayout:l="default",displayOptions:y,initialValueTemplates:b=q,menuItems:S,menuItemGroups:I,options:g,title:R}=r,{apiVersion:P,defaultOrdering:T=q,filter:p}=g,d=ht(g.params||Qe),L=r.source,m=u.useMemo(()=>tt(p,d),[p,d]),v=(y==null?void 0:y.showIcons)!==!1,[E,x]=B(m,"layout",l),w=u.useMemo(()=>(T==null?void 0:T.length)>0?{by:T}:Y,[T]),[D,K]=B(m,"sortOrder",w),X=m&&D?ot(D,f.get(m)):D,z=le(X),Q=nt(p),{error:Z,fullList:J,handleListChange:ee,isLoading:te,items:ne,onRetry:se}=ft({filter:p,params:d,sortOrder:z,apiVersion:P});return o(ue,{name:L||h,children:_(de,{currentMaxWidth:350,id:i,maxWidth:640,minWidth:320,selected:c,children:[me,o(G,{index:t,initialValueTemplates:b,menuItems:S,menuItemGroups:I,setLayout:x,setSortOrder:K,title:R}),o(lt,{childItemId:n,error:Z,filterIsSimpleTypeContraint:Q,fullList:J,isActive:a,isLoading:te,items:ne,layout:E,onListChange:ee,onRetry:se,showIcons:v})]})})});export{It as default};
